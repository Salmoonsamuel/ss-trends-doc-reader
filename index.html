<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Document Text Reader - SS Trends</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0078d7" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    .parallax-bg {
      background: url("nature.jpg") center/cover no-repeat fixed;
      position: fixed;
      inset: 0;
      width: 110%;
      height: 110%;
      transform: translate3d(0,0,0) scale(1.05);
      transition: transform .2s ease-out;
      z-index: -1;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
      text-align: center;
    }
    .app-container {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: saturate(150%) blur(3px);
      border-radius: 20px;
      padding: 30px;
      max-width: 800px;
      width: 95%;
      box-shadow: 0 4px 25px rgba(0,0,0,0.25);
    }
    .upload-label {
      background: #0078d7;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
    }
    #fileInput { display: none; }
    #progressContainer {
      width: 100%;
      background: #eee;
      border-radius: 10px;
      height: 10px;
      margin-top: 20px;
      display: none;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      border-radius: 10px;
      background: linear-gradient(90deg,#0078d7,#37d67a);
      transition: width .2s;
    }
    #progressText { font-size: 14px; margin-top: 10px; }
    pre {
      background: rgba(240,244,250,0.9);
      padding: 15px;
      border-radius: 10px;
      height: 260px;
      overflow-y: auto;
      text-align: left;
      white-space: pre-wrap;
    }
    .highlight-word {
      background: #a8d8ff;
      padding: 2px 4px;
      border-radius: 4px;
      box-shadow: 0 0 10px #a8d8ff;
    }
    .seek-container {
      width: 100%;
      margin-top: 20px;
    }
    .seek-bar {
      width: 100%;
      appearance: none;
      height: 8px;
      background: #d0d0d0;
      border-radius: 5px;
      cursor: pointer;
    }
    .seek-bar::-webkit-slider-thumb {
      appearance: none;
      height: 18px;
      width: 18px;
      background: #0078d7;
      border-radius: 50%;
    }
    .btn {
      border-radius: 10px;
      padding: 10px 20px;
    }
    .dragover {
      outline: 3px dashed #0078d7;
      outline-offset: 8px;
      background: rgba(240,248,255,0.7);
    }
    #historySearch {
      border-radius: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="parallax-bg" id="parallaxBg"></div>

  <div class="app-container" id="dropZone">
    <h1>üìñ Document Text Reader</h1>

    <label class="upload-label" for="fileInput">üìÅ Upload or Drop Document</label>
    <input id="fileInput" type="file" accept="image/*,application/pdf" />

    <div id="progressContainer"><div id="progressBar"></div></div>
    <p id="progressText"></p>

    <h4 class="mt-4">Extracted Text</h4>
    <pre id="outputText"></pre>

    <div class="mt-3">
      <label class="fw-bold">üé§ Choose Voice</label>
      <select id="voiceSelect" class="form-select text-center mt-2"></select>
      <button id="previewVoiceBtn" class="btn btn-outline-primary mt-2">üîä Preview Voice</button>
    </div>

    <div class="seek-container">
      <input type="range" class="seek-bar" id="seekBar" min="0" max="100" value="0" />
    </div>

    <div class="d-flex justify-content-center gap-2 flex-wrap mt-3">
      <button id="prevSentence" class="btn btn-secondary">‚è™ Prev Sentence</button>
      <button id="playBtn" class="btn btn-primary">‚ñ∂ Play</button>
      <button id="pauseBtn" class="btn btn-warning">‚è∏ Pause</button>
      <button id="stopBtn" class="btn btn-danger">‚èπ Stop</button>
      <button id="nextSentence" class="btn btn-secondary">‚è© Next Sentence</button>
    </div>

    <div class="d-flex justify-content-center flex-wrap gap-2 mt-3">
      <button id="downloadBtn" class="btn btn-success">üíæ Download .txt</button>
      <button id="historyBtn" class="btn btn-dark">üìú History</button>
    </div>
  </div>

  <div class="modal fade" id="historyModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">üìú History</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input id="historySearch" placeholder="üîç Search history..." />
          <div id="historyContent"></div>
        </div>
        <div class="modal-footer">
          <button id="clearHistoryBtn" class="btn btn-danger">üóë Clear History</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(console.error);
    }

    const bg = document.getElementById("parallaxBg");
    document.addEventListener("mousemove", e => {
      const x = (e.clientX / window.innerWidth - 0.5) * 20;
      const y = (e.clientY / window.innerHeight - 0.5) * 20;
      bg.style.transform = `translate3d(${x}px,${y}px,0) scale(1.05)`;
    });

    const fileInput = document.getElementById("fileInput");
    const dropZone = document.getElementById("dropZone");
    const outputText = document.getElementById("outputText");
    const voiceSelect = document.getElementById("voiceSelect");
    const previewVoiceBtn = document.getElementById("previewVoiceBtn");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn = document.getElementById("stopBtn");
    const prevSentence = document.getElementById("prevSentence");
    const nextSentence = document.getElementById("nextSentence");
    const seekBar = document.getElementById("seekBar");

    const historyBtn = document.getElementById("historyBtn");
    const historyContent = document.getElementById("historyContent");
    const historySearch = document.getElementById("historySearch");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");

    let speech = window.speechSynthesis;
    let voices = [];
    let sentences = [];
    let currentSentenceIndex = 0;
    let isPlaying = false;
    let utterance = null;

    function loadVoices() {
      voices = speech.getVoices().filter(v => v.lang.startsWith("en"));
      voiceSelect.innerHTML = voices.map(v => `<option value="${v.name}">${v.name}</option>`).join("");
      const saved = localStorage.getItem("selectedVoice");
      let preferred = voices.find(v => saved ? v.name === saved : (/female/i.test(v.name) || v.name.includes("Google UK English Female")));
      if (!preferred) preferred = voices[0];
      if (preferred) voiceSelect.value = preferred.name;
    }
    loadVoices();
    speech.onvoiceschanged = loadVoices;

    voiceSelect.addEventListener("change", () => {
      localStorage.setItem("selectedVoice", voiceSelect.value);
    });

    previewVoiceBtn.addEventListener("click", () => speak("Hello! This is a preview of my voice."));

    fileInput.addEventListener("change", e => handleFile(e.target.files[0]));
    dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    function handleFile(file) {
      if (!file) return;
      if (file.type === "application/pdf") extractPdf(file);
      else ocrImage(file);
    }

    function extractPdf(file) {
      const reader = new FileReader();
      reader.onload = async function () {
        const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
        canvas.toBlob(blob => ocrImage(blob));
      };
      reader.readAsArrayBuffer(file);
    }

    function ocrImage(image) {
      outputText.textContent = "";
      progressContainer.style.display = "block";
      progressBar.style.width = "0%";
      progressText.textContent = "Starting OCR...";

      Tesseract.recognize(image, "eng", {
        logger: info => {
          if (info.status === "recognizing text") {
            const pct = Math.round(info.progress * 100);
            progressBar.style.width = pct + "%";
            progressText.textContent = "Reading text... " + pct + "%";
          }
        }
      }).then(res => {
        progressBar.style.width = "100%";
        progressText.textContent = "Done!";
        setTimeout(() => { progressContainer.style.display = "none"; progressText.textContent = ""; }, 1000);
        const text = res.data.text.trim();
        outputText.textContent = text;
        saveHistory(text);
        setupSentences(text);
      });
    }

    function saveHistory(text) {
      if (!text) return;
      const history = JSON.parse(localStorage.getItem("ocrHistory") || "[]");
      history.unshift({ text, time: new Date().toLocaleString() });
      localStorage.setItem("ocrHistory", JSON.stringify(history));
    }

    historyBtn.addEventListener("click", () => {
      const history = JSON.parse(localStorage.getItem("ocrHistory") || "[]");
      if (!history.length) {
        historyContent.innerHTML = "<p class='text-center text-muted'>No history.</p>";
      } else {
        historyContent.innerHTML = history.map((h, i) => `
          <div class="p-3 mb-2 bg-light border rounded history-item">
            <strong>Document ${history.length - i}</strong>
            <div class="text-muted small">${h.time}</div>
            <pre class="bg-white p-2 rounded small">${h.text}</pre>
          </div>
        `).join("");
      }
      historySearch.value = "";
      new bootstrap.Modal(document.getElementById("historyModal")).show();
    });

    historySearch.addEventListener("input", () => {
      const q = historySearch.value.toLowerCase();
      document.querySelectorAll(".history-item").forEach(el => {
        el.style.display = el.innerText.toLowerCase().includes(q) ? "" : "none";
      });
    });

    clearHistoryBtn.addEventListener("click", () => {
      if (confirm("Clear all history?")) {
        localStorage.removeItem("ocrHistory");
        historyContent.innerHTML = "<p class='text-center text-muted'>No history.</p>";
      }
    });

    function setupSentences(text) {
      sentences = text.match(/[^.!?]+[.!?]*\s*/g) || [text];
      currentSentenceIndex = 0;
      highlightSentence();
      updateSeekBar();
    }

    function play() {
      if (!sentences.length) return;
      isPlaying = true;
      speech.cancel();
      utterance = new SpeechSynthesisUtterance(sentences[currentSentenceIndex]);
      utterance.rate = 0.9;
      utterance.pitch = 1;
      const selectedVoice = voices.find(v => v.name === voiceSelect.value);
      if (selectedVoice) utterance.voice = selectedVoice;
      utterance.onboundary = event => {
        if (event.name === "word") highlightWord(event.charIndex);
      };
      utterance.onend = () => { if (isPlaying) nextSentenceClick(); };
      speech.speak(utterance);
      highlightSentence();
    }

    function speak(text) {
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.9;
      u.pitch = 1;
      const selectedVoice = voices.find(v => v.name === voiceSelect.value);
      if (selectedVoice) u.voice = selectedVoice;
      speech.cancel();
      speech.speak(u);
    }

    playBtn.addEventListener("click", play);
    pauseBtn.addEventListener("click", () => speech.pause());
    stopBtn.addEventListener("click", () => {
      isPlaying = false;
      speech.cancel();
      currentSentenceIndex = 0;
      highlightSentence();
      updateSeekBar();
    });

    prevSentence.addEventListener("click", () => {
      if (currentSentenceIndex > 0) currentSentenceIndex--;
      restartReading();
    });
    nextSentence.addEventListener("click", nextSentenceClick);
    function nextSentenceClick() {
      if (currentSentenceIndex < sentences.length - 1) {
        currentSentenceIndex++;
        restartReading();
      } else {
        isPlaying = false;
      }
    }
    function restartReading() {
      speech.cancel();
      highlightSentence();
      updateSeekBar();
      if (isPlaying) play();
    }

    seekBar.addEventListener("input", () => {
      if (!sentences.length) return;
      const pct = seekBar.value / 100;
      currentSentenceIndex = Math.floor(pct * sentences.length);
      highlightSentence();
    });

    function updateSeekBar() {
      if (!sentences.length) { seekBar.value = 0; return; }
      const pct = (currentSentenceIndex / (sentences.length - 1)) * 100;
      seekBar.value = isNaN(pct) ? 0 : pct;
    }

    function highlightSentence() {
      const before = sentences.slice(0, currentSentenceIndex).join("");
      const current = sentences[currentSentenceIndex] || "";
      const after = sentences.slice(currentSentenceIndex + 1).join("");

      outputText.innerHTML =
        escapeHtml(before) +
        `<span id="currentSentence">${escapeHtml(current)}</span>` +
        escapeHtml(after);
    }

    function highlightWord(charIndex) {
      const sentenceEl = document.getElementById("currentSentence");
      if (!sentenceEl) return;
      const s = sentences[currentSentenceIndex] || "";
      const before = s.slice(0, charIndex);
      const rest = s.slice(charIndex);
      const match = rest.match(/^(\S+)/);
      const word = match ? match[1] : "";
      const after = s.slice(charIndex + word.length);

      sentenceEl.innerHTML =
        escapeHtml(before) +
        `<span class="highlight-word">${escapeHtml(word)}</span>` +
        escapeHtml(after);
    }

    function escapeHtml(str) {
      return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    downloadBtn.addEventListener("click", () => {
      const text = outputText.textContent.trim();
      if (!text) return alert("No text to download.");
      const blob = new Blob([text], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "extracted-text.txt";
      a.click();
    });
  </script>
</body>
</html>
